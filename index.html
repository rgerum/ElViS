<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ElViS - Simulator</title>

    <script src="https://unpkg.com/mathjs/dist/math.min.js"></script>
    <script src="https://d3js.org/d3.v5.min.js"></script>

    <script src="js/element.js"></script>
    <script src="js/plot.js"></script>
    <script src="js/slider.js"></script>
    <style>
        .button {
            display: inline-block;
            background: #9473c6;
            border: 1px solid #fff;
            padding: 5px 10px;
            border-radius: 10px;
            box-shadow: 0 0 0 2px #9473c6c2;
            color: black;
            cursor: pointer;
            margin-right: 3px;
            filter: saturate(0.5);
        }
        .button:hover {
            filter: saturate(1) brightness(1.1);
            color: black;
        }
        .button[active=true] {
            filter: saturate(1);
            color: black;
        }
        .bcolor1 {

        }
        .bcolor2 {
            background: #bf823b;
            box-shadow: 0 0 0 2px #bf823bc2;
        }
        .bcolor3 {
            background: #cc546d;
            box-shadow: 0 0 0 2px #cc546dc2;
        }
    </style>

    <style>
        button  {float:left}
        line    {shape-rendering: crispEdges;}
        text    {text-anchor:middle;}
        .axis line {fill:none;stroke:#555;shape-rendering: crispEdges;}
        .axis path  {fill:none;}
        .axis text {font-size:10pt;fill:#555;font-family:sans-serif}
        .plot_line {stroke-width: 2px}

        .slider.ticks {
            font: 10px sans-serif;
        }

        .slider .track,
        .slider .track-inset,
        .slider .track-overlay {
            stroke-linecap: round;
        }

        .slider .track {
            stroke: #000;
            stroke-opacity: 0.3;
            stroke-width: 10px;
        }

        .slider .track-inset {
            stroke: #ddd;
            stroke-width: 8px;
        }

        .slider .track-overlay {
            pointer-events: stroke;
            stroke-width: 50px;
            stroke: transparent;
            #cursor: crosshair;
        }

        .slider .handle {
            fill: #fff;
            stroke: #000;
            stroke-opacity: 0.5;
            stroke-width: 1.25px;
            cursor: pointer;
        }
        .slider-span {
            position: absolute;
            margin-left: -27px;
            margin-top: 1px;
        }

        d-article figure {
            text-align: center;
        }
        figcaption {
            text-align: left;
        }

        #parameters td {
            border-bottom: 1px double gray;
            padding: 5px;
        }
        #parameters tr:first-child {
            background: lightgray;
            border: 1px solid gray;
        }
        #parameters td:not(:first-child) {
            width: 80px;
            text-align: center;
        }
        #parameters tr:not(:first-child) td:not(:first-child) {
            #text-align: right;
        }

        .shaded-figure {
            background-color: hsl(200, 20%, 97%);
            border-top: 1px solid hsla(0, 0%, 0%, 0.1);
            border-bottom: 1px solid hsla(0, 0%, 0%, 0.1);
            padding: 30px 0;
            overflow-x: auto;
        }

        .annotation {
            fill: rgba(0,0,0,0.6);
            font-size: 13px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Fira Sans", "Droid Sans", "Helvetica Neue", Arial, sans-serif;
        }

        .annotated-math {
            display: grid;
            margin: 0 auto;
        }

        .annotated-math d-math::shadow {
            text-align: center;
            background:red;
        }

    </style>

</head>
<body>
<div style="width:600px; margin:0 auto">
    <div id="buttons"></div>
    <form>
        <select id="type">
            <option value="Spring">Spring</option>
            <option value="Dashpot">Dashpot</option>
        </select>
        <input id="input_number" type="number" value="1"/>
    </form>
    <svg id="display"></svg>
    <svg id="plot"></svg>
    <svg id="slider" width="500" height="30"></svg>
</div>
<script>
    function getDataPreset(i) {
        let data = undefined;
        if(i == 0)
            data = {
                "plot_point": 1,
                "points": [[0, 0], [1, 1]],
                "elements": [["Dashpot", 0, 1, 1], ["Force", 1, 1, 1, 3]],
            }
        else if(i == 1)
            data = {
                "plot_point": 1,
                "points": [[0, 0], [1, 1]],
                "elements": [["Spring", 0, 1, 1, 1], ["Spring", 0, 1, 1, 1], ["Force", 1, 1, 1, 3]],
            }
        else if(i == 2)
            data = {
                "plot_point": 2,
                "points": [[0, 0], [1, 1], [1, 2]],
                "elements": [["Dashpot", 0, 1, 1], ["Spring", 1, 2, 1, 1], ["Force", 2, 1, 1, 3]],
            }
        else if(i == 3)
            data = {
                "plot_point": 2,
                "points": [[0, 0], [1, 1], [1, 2]],
                "elements": [["Spring", 0, 1, 1, 1], ["Dashpot", 1, 2, 1], ["Spring", 1, 2, 1, 1], ["Force", 2, 1, 1, 3]],
            }
        else if(i == 4)
            data = {
                "plot_point": 2,
                "points": [[0, 0], [1, 1], [1, 2]],
                "elements": [["Dashpot", 0, 1, 1], ["Dashpot", 1, 2, 1], ["Spring", 1, 2, 1, 1], ["Force", 2, 1, 1, 3]],
            }
        return data;
    }

    d3.select("#buttons").selectAll("div").data([0, 1, 2, 3, 4]).enter().append("div")
        .text(d=>d).attr("class", "button").on("click", d=>setData(getDataPreset(d)));

    let plot = new Plot(d3.select("#plot"), {xlabel: "time", ylabel: "displacement", left: 100, bottom: 100});
    plot.setXLabel("time")
    let display = new Display(d3.select("#display"), {});
    let slider = new Slider("#slider", {range: [0, 500-1], value: 0, play:true});
    let sim = new System();
    sim.simulateOverdamped();

    plot.setXlim(0, sim.times[sim.times.length-1]);
    plot.setYlim(d3.min(sim.data), d3.max(sim.data));
    //let data2 = [];
    //for(let i = 0; i < data.length; i++)
    //    data2.push({x: sim.times[i], y: data[i]});
    //plot.setData([data2], ["displacement"])
    plot.setData([{x: sim.times, y: sim.data}], ["displacement"])

    sim.updateDrawOffsets();
    display.setData(sim.draw());
    display.setPoints(sim.points, sim);

    let selected_element_id;
    function selectedElement(i) {
        let element = sim.elements[i];
        selected_element_id = i;
        document.getElementById("input_number").value = element.strength;
        document.getElementById("type").value = element.constructor.name;
    }
    document.getElementById("input_number").oninput = function() {
        if(selected_element_id != undefined) {
            sim.elements[selected_element_id].strength = this.value;
            updateSystem();
        }
    }
    document.getElementById("type").oninput = function() {
        if(selected_element_id != undefined) {
            let element = sim.elements[selected_element_id]
            let element2 = new {"Spring": Spring, "Dashpot": Dashpot}[this.value](element.start, element.end, element.strength);
            sim.elements[selected_element_id] = element2;
            sim.updateDrawOffsets();
            updateSystem();
        }
        console.log(this);
    }

    function setData(data) {
        sim.setData(data);
        updateSystem();
    }
    function updateSystem() {
        sim.simulateOverdamped();
        display.setData(sim.draw());
        display.setPoints(sim.points, sim);
        slider.setValue(0);
        plot.setXlim(0, sim.times[sim.times.length-1]);
        plot.setYlim(d3.min(sim.data), d3.max(sim.data));
        plot.setData([{x: sim.times, y: sim.data}], ["displacement"])
        plot.setCursor(sim.times[0], sim.data[0]);
    }

    slider.setRange(0, sim.end_time/sim.h-1);
    slider.onValueChanged = function(d) {
        d = parseInt(d);
        display.setData(sim.draw(d));
        display.setPoints(sim.get_points(d), sim);
        plot.setCursor(sim.times[d], sim.data[d]);
    };
</script>
</body>
</html>